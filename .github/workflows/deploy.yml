name: Deploy to Aliyun OSS

on:
  push:
    branches:
      - main # 推送到 master 分支时自动部署

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: pnpm install

      - name: Build project
        run: pnpm run build

      - name: Setup ossutil
        run: |
          wget http://gosspublic.alicdn.com/ossutil/1.7.15/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil

      - name: Configure ossutil
        run: |
          ossutil config \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}

      - name: Upload to OSS
        run: |
          ossutil sync dist/ oss://${{ secrets.OSS_BUCKET }}/ --delete --update

      - name: Setup Aliyun CLI
        run: |
          curl -sSL https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz | tar -zx
          sudo mv aliyun /usr/local/bin/
          aliyun version

      - name: Configure Aliyun CLI
        run: |
          aliyun configure set --profile default \
            --access-key-id ${{ secrets.OSS_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.OSS_ACCESS_KEY_SECRET }} \
            --region cn-hangzhou

      - name: Refresh CDN Cache
        run: |
          aliyun cdn RefreshObjectCaches \
            --profile default \
            --ObjectPath "/index.html" \
            --ObjectType "File"
          aliyun cdn RefreshObjectCaches \
            --profile default \
            --ObjectPath "/assets/" \
            --ObjectType "Directory"

      - name: Send notification to Feishu
        if: success()
        run: |
          curl -X POST \
            ${{ secrets.FEISHU_WEBHOOK_URL }} \
            -H "Content-Type: application/json" \
            -d '{"msg_type":"text","content":"部署成功！项目: game-frontend"}'
